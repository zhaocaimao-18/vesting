# ğŸ’° ERC20 çº¿æ€§é‡Šæ”¾ï¼ˆVestingï¼‰åˆçº¦å¼€å‘å®æˆ˜æ¨¡æ¿
ğŸš€ æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªå®Œæ•´çš„ ERC20 + Vesting å®æˆ˜æ¨¡æ¿ï¼Œæ¶µç›–ä»é›¶æ„å»ºã€éƒ¨ç½²ã€æµ‹è¯•åˆ°ä¸Šçº¿çš„å…¨æµç¨‹ï¼Œé€‚åˆ Web3 åˆå­¦è€…å’Œå¼€å‘è€…å‚è€ƒå¤ç”¨ã€‚

ä½œä¸ºæˆ‘ç¬¬ä¸€é˜¶æ®µ Solidity å­¦ä¹ çš„é˜¶æ®µæ€§æˆæœï¼Œæœ¬é¡¹ç›®å›´ç»•ä¸€ä¸ªå®Œæ•´çš„çº¿æ€§é‡Šæ”¾åˆçº¦ï¼ˆVestingï¼‰å±•å¼€ï¼Œæ¨¡æ‹Ÿç°å®ä¸­ä»£å¸é€æ­¥è§£é”ï¼ˆå¦‚å›¢é˜Ÿæ¿€åŠ±ã€é¡¾é—® token åˆ†å‘ï¼‰çš„å…¸å‹åº”ç”¨åœºæ™¯ã€‚é¡¹ç›®ç›®æ ‡æ˜¯ä»é›¶å®ç°ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š

- âœ… ç¼–å†™è‡ªå®šä¹‰çš„ ERC20 Token åˆçº¦ï¼ˆä¸ä¾èµ– OpenZeppelinï¼‰
- âœ… è®¾è®¡å¹¶å®ç° Vesting åˆçº¦ï¼Œæ”¯æŒçº¿æ€§é‡Šæ”¾é€»è¾‘
- âœ… ä½¿ç”¨ Factory æ¨¡å¼æ‰¹é‡åˆ›å»º Vesting åˆçº¦
- âœ… ç¼–å†™å®Œæ•´çš„éƒ¨ç½²è„šæœ¬å’Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ç½‘ï¼Œç¡®ä¿é€»è¾‘æ­£ç¡®æ€§

æœ¬é¡¹ç›®ä¸ä¾èµ–æ¨¡æ¿å·¥ç¨‹ï¼Œè€Œæ˜¯ä»åˆå§‹åŒ– Hardhat é¡¹ç›®ã€ç¼–å†™åˆçº¦ã€éƒ¨ç½²åˆ°æµ‹è¯•è„šæœ¬ï¼Œä¸€æ­¥æ­¥æ„å»ºè€Œæˆï¼Œç›®æ ‡æ˜¯**æ„å»ºä¸€ä»½ç»“æ„æ¸…æ™°ã€é€»è¾‘ä¸¥è°¨ã€å¯å¤ç”¨çš„ Web3 å¼€å‘å®è·µé¡¹ç›®æ¨¡æ¿**ã€‚
## ç›®å½•
- [ğŸ’° ERC20 çº¿æ€§é‡Šæ”¾ï¼ˆVestingï¼‰åˆçº¦å¼€å‘å®æˆ˜æ¨¡æ¿](#-erc20-çº¿æ€§é‡Šæ”¾vestingåˆçº¦å¼€å‘å®æˆ˜æ¨¡æ¿)
  - [ç›®å½•](#ç›®å½•)
  - [â™»ï¸ 0.å¦‚ä½•å¤ç”¨æœ¬é¡¹ç›®](#ï¸-0å¦‚ä½•å¤ç”¨æœ¬é¡¹ç›®)
  - [ğŸ§  1. é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡](#-1-é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡)
    - [1.1 å‰æœŸé¡¹ç›®å‡†å¤‡PreStep](#11-å‰æœŸé¡¹ç›®å‡†å¤‡prestep)
  - [ğŸ§± 2. åˆçº¦è®¾è®¡ä¸å®ç°](#-2-åˆçº¦è®¾è®¡ä¸å®ç°)
    - [2.1 MyToken åˆçº¦ï¼ˆè‡ªå®šä¹‰ ERC20 å®ç°ï¼‰](#21-mytoken-åˆçº¦è‡ªå®šä¹‰-erc20-å®ç°)
      - [è®¾è®¡ç›®æ ‡](#è®¾è®¡ç›®æ ‡)
      - [æ ¸å¿ƒæ•°æ®ç»“æ„](#æ ¸å¿ƒæ•°æ®ç»“æ„)
    - [2.2 Vesting åˆçº¦](#22-vesting-åˆçº¦)
      - [æ„é€ å‡½æ•°å‚æ•°è¯´æ˜](#æ„é€ å‡½æ•°å‚æ•°è¯´æ˜)
      - [çº¿æ€§é‡Šæ”¾è®¡ç®—é€»è¾‘ï¼ˆæŒ‰ç§’é‡Šæ”¾ï¼‰](#çº¿æ€§é‡Šæ”¾è®¡ç®—é€»è¾‘æŒ‰ç§’é‡Šæ”¾)
      - [`claim()` æ–¹æ³•ç»†èŠ‚è§£æ](#claim-æ–¹æ³•ç»†èŠ‚è§£æ)
    - [2.3 VestingFactory åˆçº¦](#23-vestingfactory-åˆçº¦)
  - [ğŸ“¦ 3. éƒ¨ç½²æµç¨‹ä¸è„šæœ¬ç»“æ„](#-3-éƒ¨ç½²æµç¨‹ä¸è„šæœ¬ç»“æ„)
  - [ğŸ§ª 4. æµ‹è¯•è®¾è®¡ä¸è¦†ç›–ç­–ç•¥](#-4-æµ‹è¯•è®¾è®¡ä¸è¦†ç›–ç­–ç•¥)
    - [4.1 è¿è¡Œ](#41-è¿è¡Œ)
    - [4.2 æµ‹è¯•ç½‘](#42-æµ‹è¯•ç½‘)
    - [ğŸ›  æœªæ¥æ”¹è¿›æ–¹å‘](#-æœªæ¥æ”¹è¿›æ–¹å‘)


## â™»ï¸ 0.å¦‚ä½•å¤ç”¨æœ¬é¡¹ç›®
  ä½ å¯ä»¥ clone æœ¬é¡¹ç›®å¹¶å¿«é€Ÿæ›¿æ¢ä»¥ä¸‹æ¨¡å—ï¼š
  - `MyToken.sol`ï¼šæ”¹ä¸ºä½ è‡ªå·±çš„ä»£å¸é€»è¾‘
  - `Vesting.sol`ï¼šæ›¿æ¢æˆæŒ‰æ¯”ä¾‹é‡Šæ”¾ã€è§£é”é˜ˆå€¼ç­‰æ›´å¤æ‚çš„é€»è¾‘
  - `factory/*.js`ï¼šæ ¹æ®éƒ¨ç½²åˆçº¦ä¸åŒæ‰©å±•éƒ¨ç½²æµç¨‹
  - `.env.enc`ï¼šæ¢æˆä½ è‡ªå·±çš„æµ‹è¯•ç½‘ RPC ä¸ç§é’¥

## ğŸ§  1. é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡
- Token åˆ†å‘ä¸ºä»€ä¹ˆéœ€è¦ Vestingä»¥åŠ æœ¬é¡¹ç›®è¦è§£å†³çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
    åœ¨ Web3 é¡¹ç›®ä¸­ï¼Œå¸¸è§çš„åˆä½œå…³ç³»å¾€å¾€åŒ…å«ç”²æ–¹ï¼ˆèµ„æ–¹ï¼‰ä¸ä¹™æ–¹ï¼ˆå¼€å‘æ–¹æˆ–é¡¾é—®ï¼‰ã€‚ç”²æ–¹å¸Œæœ›æ¿€åŠ±ä¹™æ–¹æŒç»­ä¸ºé¡¹ç›®è´¡çŒ®ä»·å€¼ï¼Œè€Œä¸æ˜¯â€œä¸€æ¬¡æ€§æ‹¿é’±èµ°äººâ€ï¼›ä¹™æ–¹åˆ™æ‹…å¿ƒåŠªåŠ›å·¥ä½œåæ‹¿ä¸åˆ°æŠ¥é…¬ã€‚
    äºæ˜¯ï¼ŒVestingï¼ˆçº¿æ€§é‡Šæ”¾ï¼‰æœºåˆ¶å°±åº”è¿è€Œç”Ÿï¼Œå®ƒè§£å†³äº†ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
    - âœ… é˜²æ­¢ä¹™æ–¹æå‰è·‘è·¯ï¼šèµ„æ–¹é€šè¿‡å°†èµ„é‡‘é”å®šåœ¨ Vesting åˆçº¦ä¸­ï¼Œè®©ä¹™æ–¹åªèƒ½â€œéšæ—¶é—´é€æ­¥é¢†å–â€ï¼Œé˜²æ­¢ä¸€æ¬¡æ€§æå–æ‰€æœ‰èµ„é‡‘ã€‚
    - âœ… é˜²æ­¢èµ„æ–¹èµ–è´¦ï¼šåˆçº¦å†™æ­»é‡Šæ”¾é€»è¾‘ï¼Œä¸€æ—¦éƒ¨ç½²ï¼Œç”²æ–¹æ— æ³•éšæ„æ›´æ”¹æˆ–é˜»æ­¢é‡Šæ”¾ï¼Œç¡®ä¿ä¹™æ–¹æƒç›Šã€‚
    - âœ… é“¾ä¸Šé€æ˜ã€å¯è¿½è¸ªï¼šVesting åˆçº¦åœ¨é“¾ä¸Šå…¬å¼€éƒ¨ç½²ï¼Œèµ„é‡‘ä½™é¢å’Œé‡Šæ”¾çŠ¶æ€å®Œå…¨å¯éªŒè¯ï¼Œå»ºç«‹ä¿¡ä»»æœºåˆ¶ã€‚
    - ğŸ“Œ ç®€åŒ–ç†è§£ï¼šVesting å°±åƒä¸€ä¸ªâ€œåŒºå—é“¾ä¸Šçš„åˆ†æœŸä»˜æ¬¾ç³»ç»Ÿâ€ï¼ŒæŠŠä¿¡ä»»å˜æˆä»£ç ï¼ŒæŠŠæ‰¿è¯ºå†™å…¥æ—¶é—´ã€‚
- é¡¹ç›®æ•´ä½“æ¶æ„å›¾ todo                     
### 1.1 å‰æœŸé¡¹ç›®å‡†å¤‡PreStep
1. create project
   1. `mkdir vesting` åˆ›å»ºç›®å½•
   2. `npm init  -y `  æ„å»º npmé¡¹ç›®
   3. `npm install --save-dev hardhat` åœ¨å¼€å‘åˆ†æ”¯ä¸‹è½½`hardhat`
   4. `npx hardhat` æ ‡è®°é¡¹ç›®ä¸ºhardhaté¡¹ç›®
      1. ç¡®è®¤ä¸‹è½½`npm install --save-dev @nomicfoundation/hardhat-toolbox` 
   5. `git init` optional
2. check
   1. è¾“å…¥`npx hardhat --version` å’Œ ç»“æ„å¦‚ä¸‹ï¼š
   2. ```shell
          vesting/
            â”œâ”€â”€ contracts/            # Your Solidity contracts (e.g., Lock.sol)
            â”œâ”€â”€ test/                 # JS-based test scripts
            â”œâ”€â”€ hardhat.config.js     # Core Hardhat config file
            â”œâ”€â”€ package.json          # npm dependency manager
            â”œâ”€â”€ .gitignore            # Common .git exclusions
            â”œâ”€â”€ node_modules/         # Installed packages
            â”œâ”€â”€ package-lock.json     # Exact dependency lock
    ```
## ğŸ§± 2. åˆçº¦è®¾è®¡ä¸å®ç°
### 2.1 MyToken åˆçº¦ï¼ˆè‡ªå®šä¹‰ ERC20 å®ç°ï¼‰
#### è®¾è®¡ç›®æ ‡
`MyToken` æ˜¯æœ¬é¡¹ç›®ä¸­ç”¨äºæµ‹è¯• Vesting åŠŸèƒ½çš„ ERC20 ä»£å¸åˆçº¦ã€‚æˆ‘ä»¬ä¸ä½¿ç”¨ OpenZeppelin çš„æ ‡å‡†åº“ï¼Œè€Œæ˜¯ä»é›¶æ‰‹å†™ ERC20 çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ—¨åœ¨æ·±å…¥ç†è§£ï¼š
- ERC20 çš„è´¦æˆ·ä½™é¢ç®¡ç†åŸç†
- æˆæƒæœºåˆ¶ï¼ˆapprove / allowance / transferFromï¼‰
- mint é“¸é€ å‡½æ•°çš„æƒé™æ§åˆ¶
- Transfer / Approval ç­‰æ ‡å‡†äº‹ä»¶çš„ç”¨é€”

#### æ ¸å¿ƒæ•°æ®ç»“æ„
```solidity
    mapping(address => uint256) balances;
    mapping(address=> mapping(address => uint256)) _allowance;
```
- balancesï¼šè®°å½•æ¯ä¸ªåœ°å€æ‹¥æœ‰çš„ä»£å¸æ•°é‡
- allowanceï¼šåµŒå¥—æ˜ å°„ï¼Œè®°å½•ã€Œæˆæƒåœ°å€ã€å¯ä»¥ä»ã€Œè¢«æˆæƒåœ°å€ã€è½¬å‡ºå¤šå°‘ä»£å¸
  
### 2.2 Vesting åˆçº¦
`Vesting`æ˜¯æœ¬é¡¹ç›®ä¸­ç”¨äºæä¾›çº¿æ€§é‡Šæ”¾ä¹Ÿå°±æ˜¯ç»™ä¹™æ–¹`claim()`çš„å…¥å£é¡¹ç›®ï¼Œè¿™é‡Œä¼šæ˜ç¡®ï¼š
#### æ„é€ å‡½æ•°å‚æ•°è¯´æ˜
- beneficiaryï¼šæ”¶ç›Šäººçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¹™æ–¹åœ°å€
- totalAmountï¼šå—ç›Šäººçš„æ€»æ”¶ç›Š
- durationï¼šæ”¶ç›Šäººçš„æ”¶ç›Šæ€»å‘¨æœŸ
- tokenAddresï¼šä½¿ç”¨ä»£å¸çš„åœ°å€
#### çº¿æ€§é‡Šæ”¾è®¡ç®—é€»è¾‘ï¼ˆæŒ‰ç§’é‡Šæ”¾ï¼‰
```text
    if now <= start:
        vested = 0
    elif now >= start + duration:
        vested = totalAmount
    else:
        vested = (now - start) * totalAmount / duration
```
#### `claim()` æ–¹æ³•ç»†èŠ‚è§£æ
1. æ£€æµ‹å·²ç»æ‹¿åˆ°äº†é’±ï¼šclaimedå˜é‡å½“ä¸­
2. è°ƒç”¨çº¿æ€§é‡Šæ”¾é€»è¾‘å¾—åˆ°ï¼š_vestedAmount
3. `claim=vestedAmount - claimed`
### 2.3 VestingFactory åˆçº¦
- ä¸ºä»€ä¹ˆç”¨ Factory æ¨¡å¼ï¼Ÿ
  - å› ä¸ºvestingçš„å—ç›Šäººå¾ˆå¤šï¼Œå¹¶ä¸”æ”¶ç›Šäººå¯èƒ½éœ€è¦å¤šä¸ªvestingåˆçº¦çš„æƒ…å†µï¼Œå¦‚æœå•ç‹¬éƒ¨ç½²vestingè´¹æ—¶è´¹åŠ›ï¼Œä¸å¦‚é€šè¿‡å·¥å‚æ¨¡å¼ï¼Œç®€åŒ–æ­¥éª¤ï¼Œå‡å°‘é”™è¯¯
- `createVesting`æ ¸å¿ƒæ–¹æ³•ï¼ŒåŠŸèƒ½å¦‚ä¸‹ï¼š
  - åˆ›å»º`Vesting`åˆçº¦
  - æ·»åŠ åˆ°vestingsOfå½“ä¸­ï¼Œä»¥beneficiaryä¸ºkeyï¼Œåˆçº¦vestingså½“ä¸­
  - å‘é€`VestingCreated`äº‹ä»¶

## ğŸ“¦ 3. éƒ¨ç½²æµç¨‹ä¸è„šæœ¬ç»“æ„
- Hardhat é¡¹ç›®åˆå§‹åŒ–æµç¨‹
  - åˆå§‹åŒ– Hardhat é¡¹ç›®ï¼šnpx hardhat
    
  - å®‰è£…hardhat-deploy-ethers
    - `npm install --save-dev @nomicfoundation/hardhat-ethers ethers hardhat-deploy hardhat-deploy-ethers`
    - åœ¨hardhat.config.js
       ```js 
        require("@nomicfoundation/hardhat-ethers");
        require("hardhat-deploy");
        require("hardhat-deploy-ethers");
        module.exports = {
          networks: {
            hardhat: {},
          },
          namedAccounts: {
            deployer: {
              default: 0,
            },
          },
          solidity: "0.8.20",
        };
       ```
    - ğŸ” ç†è§£æ’ä»¶ä¹‹é—´çš„å…³ç³»
      | æ’ä»¶åç§°                              | åŠŸèƒ½                                                                                                                 |
      | --------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
      | `ethers`                          | Ethers.js åŸå§‹åº“ï¼ˆé“¾ä¸Šäº¤äº’ï¼‰                                                                                                |
      | `@nomicfoundation/hardhat-ethers` | è®© Hardhat æ”¯æŒ ethers.js                                                                                             |
      | `hardhat-deploy`                  | Hardhat éƒ¨ç½²æ’ä»¶ï¼Œæä¾›ç»“æ„åŒ–éƒ¨ç½²æœºåˆ¶                                                                                             |
      | `hardhat-deploy-ethers`           | å°† `hardhat-deploy` ä¸ `ethers.js` æ•´åˆï¼Œè®©ä½ åœ¨éƒ¨ç½²è„šæœ¬ä¸­è·å¾—æ›´ä¸°å¯Œçš„ ethers APIï¼ˆæ¯”å¦‚ `getContract`, `getSigner`, `getNamedAccounts` ç­‰ï¼‰ |

      
## ğŸ§ª 4. æµ‹è¯•è®¾è®¡ä¸è¦†ç›–ç­–ç•¥
### 4.1 è¿è¡Œ 
è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š
```bash
npx hardhat test
```
è¿è¡Œå•ä¸ªæ–‡ä»¶ï¼š
```bash
npx hardhat test test/token.test.js
```
### 4.2 æµ‹è¯•ç½‘
æˆ‘ä»¬å†™åˆçº¦æœ€ç»ˆéƒ½æ˜¯è¦ä¸Šé“¾çš„ï¼Œä½†ï¼š
- æœ¬åœ°éƒ¨ç½²ä¸å…·å¤‡é“¾çš„çœŸå®äº¤äº’ç¯å¢ƒ
- ä¸»ç½‘éƒ¨ç½²å¤ªè´µï¼Œä¹Ÿæ— æ³•è¯•é”™
å› æ­¤ï¼ŒSepolia ä½œä¸ºå®˜æ–¹ä¸»æ¨çš„æµ‹è¯•é“¾ï¼Œéå¸¸é€‚åˆå¼€å‘é˜¶æ®µä½¿ç”¨ã€‚
1. æ³¨å†Œä¸€ä¸ªé’±åŒ…MetaMask
   1. è®¿é—® Sepolia æ°´é¾™å¤´è·å–æµ‹è¯• ETHï¼šå®˜æ–¹æ°´é¾™å¤´ï¼šhttps://sepoliafaucet.com/
   2. æ˜ç¡®é’±åŒ…åŠŸèƒ½ ç§é’¥ å…¬é’¥ç­‰
2. æ³¨å†Œä¸€ä¸ª Alchemy è´¦å·=ã€‹appä¸‹ å¾—åˆ°æµ‹è¯•ç½‘çš„api å¦‚ï¼š`https://eth-sepolia.g.alchemy.com/v2/xxx`
3. é…ç½® Hardhat æ”¯æŒ Sepolia
   1. ä¸‹è½½env-enc:`npm install --save-dev @chainlink/env-enc`
   2. `npx env-enc set-pw` é…ç½®å¯†ç 
   3. `npx env-enc set` åŠ å¯†æ¯”å¦‚ `key:ALCHEMY_SEPOLIA_URL,value:https://eth-sepolia.g.alchemy.com/v2/xxx`
   4. hardhat.config.js 
       ```js
        require("@chainlink/env-enc").config()
        require("@nomicfoundation/hardhat-ethers");
        require("hardhat-deploy");
        require("hardhat-deploy-ethers");

        const { PRIVATE_KEY, ALCHEMY_SEPOLIA_URL } =  process.env

        module.exports = {
          solidity: "0.8.20",
          namedAccounts: {
            deployer: {
              default: 0,
              sepolia: 0,
            },
          },
          networks: {
            sepolia: {
              url: ALCHEMY_SEPOLIA_URL,
              accounts: [PRIVATE_KEY],
              chainId: 11155111,
              saveDeployments: true,
            },
          },
        };
      ```
4. è¿è¡Œ `npx hardhat test test/token.test.js --network sepolia`
5. æ€»ç»“ï¼šéƒ¨ç½²åˆ°æµ‹è¯•ç½‘ä½ éœ€è¦å‡†å¤‡çš„å°±3æ ·ä¸œè¥¿
  1. ä¸€ä¸ª EOA é’±åŒ…ï¼ˆæ¯”å¦‚ MetaMaskï¼‰+ æµ‹è¯• ETH
  2. ä¸€ä¸ª RPC æä¾›è€…ï¼ˆæ¯”å¦‚ Alchemyï¼‰
  3. ä¸€ä¸ªéƒ¨ç½²è„šæœ¬ï¼ˆHardhat + hardhat-deployï¼‰
6. éªŒè¯ Etherscan  todo
7. TODO
### ğŸ›  æœªæ¥æ”¹è¿›æ–¹å‘
    - [ ] æ·»åŠ åŸºäº MerkleProof çš„æ‰¹é‡é¢†å–åŠŸèƒ½
    - [ ] æ”¯æŒ cliff periodï¼ˆæ‚¬å´–æœŸï¼‰ä¸å¯é…ç½®é‡Šæ”¾å‘¨æœŸ
    - [ ] å¼•å…¥ Chainlink Keepers è‡ªåŠ¨è§¦å‘é‡Šæ”¾

